## ğŸ“‹ MÃ” Táº¢ BÃ€I TOÃN HANOIGO

### **BÃ i toÃ¡n**

NgÆ°á»i dÃ¹ng tráº» táº¡i HÃ  Ná»™i gáº·p khÃ³ khÄƒn khi tÃ¬m Ä‘á»‹a Ä‘iá»ƒm Äƒn uá»‘ng, vui chÆ¡i phÃ¹ há»£p vÃ¬ cÃ¡c ná»n táº£ng hiá»‡n táº¡i chá»‰ cÃ³ bá»™ lá»c tÄ©nh, khÃ´ng hiá»ƒu ngá»¯ cáº£nh cÃ¡ nhÃ¢n nhÆ° tÃ¢m tráº¡ng, má»¥c Ä‘Ã­ch hay ngÃ¢n sÃ¡ch. Viá»‡c tÃ¬m kiáº¿m máº¥t thá»i gian vÃ  gá»£i Ã½ thÆ°á»ng khÃ´ng Ä‘Ãºng gu.

### **Giáº£i phÃ¡p**

HANOIGO lÃ  ná»n táº£ng web tÃ­ch há»£p AI Chatbot thÃ´ng minh sá»­ dá»¥ng cÃ´ng nghá»‡ RAG (Retrieval-Augmented Generation) Ä‘á»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ tÃ¬m kiáº¿m Ä‘á»‹a Ä‘iá»ƒm báº±ng ngÃ´n ngá»¯ tá»± nhiÃªn, nháº­n gá»£i Ã½ cÃ¡ nhÃ¢n hÃ³a dá»±a trÃªn sá»Ÿ thÃ­ch vÃ  ngá»¯ cáº£nh, Ä‘á»“ng thá»i há»‡ thá»‘ng liÃªn tá»¥c há»c há»i tá»« pháº£n há»“i ngÆ°á»i dÃ¹ng.

## ğŸ› ï¸ CÃ”NG NGHá»† Sá»¬ Dá»¤NG     

### **Ná»n táº£ng chÃ­nh**

- **MERN Stack**: MongoDB, Express.js, React, Node.js
- **AI Engine**: OpenAI API káº¿t há»£p RAG Architecture
- **Database**: MongoDB, Pinecone
- **Cloud Storage**: Cloudinary lÆ°u trá»¯ hÃ¬nh áº£nh
- **Báº£o máº­t**: JWT Authentication


### **Kiáº¿n trÃºc AI**

Há»‡ thá»‘ng sá»­ dá»¥ng RAG Ä‘á»ƒ káº¿t há»£p semantic search tá»« database vá»›i kháº£ nÄƒng sinh ngÃ´n ngá»¯ tá»± nhiÃªn cá»§a LLM, táº¡o cÃ¢u tráº£ lá»i chÃ­nh xÃ¡c vÃ  cÃ³ ngá»¯ cáº£nh.

## ğŸ“Š Cáº¤U TRÃšC Dá»® LIá»†U

### **Collection users**

LÆ°u thÃ´ng tin tÃ i khoáº£n ngÆ°á»i dÃ¹ng bao gá»“m email, máº­t kháº©u Ä‘Ã£ mÃ£ hÃ³a, áº£nh Ä‘áº¡i diá»‡n tá»« Cloudinary. Äáº·c biá»‡t quan trá»ng lÃ  pháº§n preferences lÆ°u sá»Ÿ thÃ­ch vá» mÃ³n Äƒn yÃªu thÃ­ch, phong cÃ¡ch khÃ´ng gian vÃ  cháº¿ Ä‘á»™ Äƒn uá»‘ng Ä‘á»ƒ há»‡ thá»‘ng cÃ¡ nhÃ¢n hÃ³a gá»£i Ã½.

### **Collection admins**

Quáº£n lÃ½ tÃ i khoáº£n quáº£n trá»‹ viÃªn vá»›i phÃ¢n quyá»n chi tiáº¿t. Admin cÃ³ thá»ƒ quáº£n lÃ½ Ä‘á»‹a Ä‘iá»ƒm, gáº¯n semantic tags, vÃ  cáº¥u hÃ¬nh/huáº¥n luyá»‡n AI mÃ  khÃ´ng cáº§n code thÃ´ng qua giao diá»‡n web.

### **Collection places (RAG Knowledge Base)**

ÄÃ¢y lÃ  "bá»™ nÃ£o" cá»§a há»‡ thá»‘ng, lÆ°u thÃ´ng tin chi tiáº¿t Ä‘á»‹a Ä‘iá»ƒm gá»“m tÃªn, Ä‘á»‹a chá»‰, quáº­n/huyá»‡n, danh má»¥c, mÃ´ táº£, khoáº£ng giÃ¡, hÃ¬nh áº£nh vÃ  menu. Äiá»ƒm Ä‘áº·c biá»‡t lÃ  aiTags - bá»™ semantic tags gá»“m:

- **space**: mÃ´ táº£ khÃ´ng gian váº­t lÃ½ (áº¥m cÃºng, ngoÃ i trá»i, rá»™ng rÃ£i)
- **mood**: cáº£m xÃºc/khÃ´ng khÃ­ (lÃ£ng máº¡n, chill, sÃ´i Ä‘á»™ng)
- **suitability**: má»¥c Ä‘Ã­ch sá»­ dá»¥ng (háº¹n hÃ², há»c bÃ i, tá»¥ táº­p nhÃ³m)


### **Collection reviews (Feedback Loop)**

LÆ°u Ä‘Ã¡nh giÃ¡ cá»§a ngÆ°á»i dÃ¹ng gá»“m rating 1-5 sao, bÃ¬nh luáº­n, áº£nh review vÃ  cÃ¡c tags mÃ´ táº£ tráº£i nghiá»‡m. Dá»¯ liá»‡u nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ cáº£i thiá»‡n Ä‘á»™ chÃ­nh xÃ¡c cá»§a AI qua thá»i gian.

## ğŸ”„ LUá»’NG HOáº T Äá»˜NG

### **TÃ¬m kiáº¿m truyá»n thá»‘ng**

NgÆ°á»i dÃ¹ng dÃ¹ng bá»™ lá»c thÃ´ng thÆ°á»ng theo danh má»¥c, quáº­n, khoáº£ng giÃ¡ Ä‘á»ƒ xem danh sÃ¡ch Ä‘á»‹a Ä‘iá»ƒm.

### **AI Chatbot (RAG)**

1. NgÆ°á»i dÃ¹ng nháº­p cÃ¢u há»i tá»± nhiÃªn tiáº¿ng Viá»‡t nhÆ° "TÃ¬m quÃ¡n cafe yÃªn tÄ©nh Ä‘á»ƒ há»c bÃ i, giÃ¡ dÆ°á»›i 100k"
2. Há»‡ thá»‘ng phÃ¢n tÃ­ch vÃ  trÃ­ch xuáº¥t semantic intent: suitability=há»c bÃ i, mood=yÃªn tÄ©nh, priceRange=dÆ°á»›i 100k
3. RAG retrieval tÃ¬m kiáº¿m trong MongoDB dá»±a trÃªn semantic tags vÃ  preferences cá»§a user
4. Káº¿t quáº£ Ä‘Æ°á»£c káº¿t há»£p vá»›i ngá»¯ cáº£nh vÃ  gá»­i Ä‘áº¿n OpenAI API
5. AI sinh cÃ¢u tráº£ lá»i tá»± nhiÃªn kÃ¨m danh sÃ¡ch Ä‘á»‹a Ä‘iá»ƒm phÃ¹ há»£p nháº¥t

### **Feedback Loop**

Sau má»—i gá»£i Ã½, ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ má»©c Ä‘á»™ há»¯u Ã­ch. Dá»¯ liá»‡u nÃ y Ä‘Æ°á»£c thu tháº­p vÃ o reviews collection Ä‘á»ƒ tinh chá»‰nh thuáº­t toÃ¡n gá»£i Ã½, giÃºp há»‡ thá»‘ng ngÃ y cÃ ng thÃ´ng minh hÆ¡n.

### **Hiá»ƒn thá»‹ Äá»‹a Ä‘iá»ƒm Má»›i nháº¥t (Homepage)**

1. **Client**: Component Grid trong trang Home tá»± Ä‘á»™ng gá»i `placesAPI.getLatest(5)` khi mount
2. **Server**: Endpoint `/api/places/latest` query MongoDB vá»›i:
   - Filter: `status: 'Published'` vÃ  `isActive: true`
   - Sort: `createdAt: -1` (má»›i nháº¥t trÆ°á»›c)
   - Limit: 5 Ä‘á»‹a Ä‘iá»ƒm
3. **Response**: Tráº£ vá» 5 Ä‘á»‹a Ä‘iá»ƒm má»›i nháº¥t vá»›i fields: name, description, images, priceRange, category, district
4. **Client**: Grid component transform data vÃ  hiá»ƒn thá»‹ trong layout responsive
5. **Auto-update**: Má»—i khi admin táº¡o Ä‘á»‹a Ä‘iá»ƒm má»›i â†’ refresh trang chá»§ â†’ Grid tá»± Ä‘á»™ng hiá»ƒn thá»‹ Ä‘á»‹a Ä‘iá»ƒm má»›i

**Lá»£i Ã­ch**: Trang chá»§ luÃ´n hiá»ƒn thá»‹ ná»™i dung má»›i nháº¥t, tÄƒng engagement vÃ  khÃ¡m phÃ¡ cÃ¡c Ä‘á»‹a Ä‘iá»ƒm má»›i.

### **Import Dá»¯ liá»‡u Tá»± Ä‘á»™ng tá»« Goong Maps API** ğŸ—ºï¸

Admin cÃ³ thá»ƒ nhanh chÃ³ng import Ä‘á»‹a Ä‘iá»ƒm tá»« Goong Maps thay vÃ¬ nháº­p thá»§ cÃ´ng:

1. **Admin Dashboard**: Truy cáº­p trang "Import Data" trong Admin panel
2. **Search**: Nháº­p keyword (vÃ­ dá»¥: "cafe há»c bÃ i"), location (tá»a Ä‘á»™ HÃ  Ná»™i), radius (5km)
3. **Goong Autocomplete**: Backend gá»i Goong API `/Place/AutoComplete` â†’ tráº£ vá» danh sÃ¡ch gá»£i Ã½
4. **Select Places**: Admin tick chá»n Ä‘á»‹a Ä‘iá»ƒm muá»‘n import tá»« báº£ng (checkbox multi-select)
5. **Fetch Details**: Backend gá»i Goong API `/Place/Detail` cho tá»«ng Ä‘á»‹a Ä‘iá»ƒm Ä‘Ã£ chá»n
6. **Map Data**: 
   - `goongProvider.js` chuáº©n hÃ³a dá»¯ liá»‡u tá»« Goong
   - `placeMapper.js` transform sang Place schema cá»§a MongoDB
   - Tá»± Ä‘á»™ng mapping: name, address, coordinates, category, phone
7. **Upsert MongoDB**: 
   - Kiá»ƒm tra `goongId` Ä‘á»ƒ trÃ¡nh duplicate
   - **Update** náº¿u Ä‘á»‹a Ä‘iá»ƒm Ä‘Ã£ tá»“n táº¡i
   - **Create** náº¿u Ä‘á»‹a Ä‘iá»ƒm má»›i
8. **Import Summary**: Hiá»ƒn thá»‹ káº¿t quáº£:
   - âœ… Imported: X places
   - ğŸ”„ Updated: Y places
   - â­ï¸ Skipped: Z duplicates
   - âŒ Errors: N failed

**Luá»“ng ká»¹ thuáº­t:**
```
Admin Frontend (GoongImportPage)
    â†“ [POST /admin/import/goong/autocomplete]
Backend (adminImportController)
    â†“ 
goongProvider â†’ Goong Maps API
    â†“
placeImportService â†’ Validate & Transform
    â†“
placeMapper â†’ Map to Place schema
    â†“
MongoDB â†’ Upsert (update/insert)
    â†“
Response â†’ Import summary
```

**TÃ­nh nÄƒng bá»• sung:**
- **Validate API Key**: Endpoint `/goong/validate-api-key` kiá»ƒm tra Goong token
- **Import Stats**: Dashboard hiá»ƒn thá»‹:
  - Total places in DB
  - Places from Goong vs Manual
  - Places needing AI enrichment
- **Re-sync**: Cáº­p nháº­t láº¡i data tá»« Goong cho Ä‘á»‹a Ä‘iá»ƒm cÅ©
- **Needs Enrichment**: Filter places thiáº¿u aiTags Ä‘á»ƒ admin gáº¯n semantic tags

**Lá»£i Ã­ch**:
- âš¡ TÄƒng tá»‘c Ä‘á»™ táº¡o content (5-10 phÃºt import hÃ ng chá»¥c Ä‘á»‹a Ä‘iá»ƒm)
- ğŸ¯ Giáº£m lá»—i nháº­p liá»‡u thá»§ cÃ´ng
- ğŸ”„ Dá»¯ liá»‡u luÃ´n fresh tá»« Goong Maps
- ğŸ¤– TÃ­ch há»£p sáºµn Ä‘á»ƒ AI enrichment sau

## âœ¨ ÄIá»‚M Ná»”I Báº¬T

**Hybrid Search**: Káº¿t há»£p tÃ¬m kiáº¿m theo tá»« khÃ³a cá»©ng (tÃªn Ä‘á»‹a Ä‘iá»ƒm, Ä‘á»‹a chá»‰) vÃ  semantic search (tÃ¢m tráº¡ng, ngá»¯ cáº£nh sá»­ dá»¥ng) Ä‘á»ƒ cho káº¿t quáº£ toÃ n diá»‡n.

**CÃ¡ nhÃ¢n hÃ³a thÃ´ng minh**: Há»‡ thá»‘ng Æ°u tiÃªn gá»£i Ã½ Ä‘á»‹a Ä‘iá»ƒm phÃ¹ há»£p vá»›i sá»Ÿ thÃ­ch cÃ¡ nhÃ¢n tá»« preferences, khÃ´ng chá»‰ dá»±a vÃ o query hiá»‡n táº¡i.

**Admin-friendly AI Control**: Quáº£n trá»‹ viÃªn cÃ³ thá»ƒ lÃ m giÃ u dá»¯ liá»‡u báº±ng cÃ¡ch gáº¯n semantic tags vÃ  Ä‘iá»u chá»‰nh prompt AI qua giao diá»‡n web, khÃ´ng cáº§n kiáº¿n thá»©c láº­p trÃ¬nh.

**Auto Import tá»« Goong Maps**: TÃ­ch há»£p API Goong Maps cho phÃ©p Admin import hÃ ng loáº¡t Ä‘á»‹a Ä‘iá»ƒm chá»‰ vá»›i vÃ i click, tá»± Ä‘á»™ng mapping data vÃ  upsert vÃ o MongoDB, tiáº¿t kiá»‡m thá»i gian vÃ  giáº£m lá»—i nháº­p liá»‡u.

**Há»c liÃªn tá»¥c**: Má»—i review vÃ  pháº£n há»“i tá»« ngÆ°á»i dÃ¹ng Ä‘á»u giÃºp cáº£i thiá»‡n Ä‘á»™ chÃ­nh xÃ¡c cá»§a gá»£i Ã½ trong tÆ°Æ¡ng lai, táº¡o vÃ²ng láº·p cáº£i tiáº¿n khÃ´ng ngá»«ng.


# ğŸ“ Cáº¤U TRÃšC FRONTEND - HANOIGO

## ğŸ¯ Tá»•ng quan

Frontend Ä‘Æ°á»£c xÃ¢y dá»±ng báº±ng **React** vá»›i kiáº¿n trÃºc modular, phÃ¢n tÃ¡ch rÃµ rÃ ng giá»¯a UI, business logic, vÃ  data management. Sá»­ dá»¥ng **React Query** cho server state vÃ  **Context API** cho authentication state.

***

## ğŸ“‚ Cáº¥u trÃºc máº«u cho ThÆ° má»¥c ChÃ­nh

```
client/
â”œâ”€â”€ public/                      # Static assets (favicon, manifest)
â”‚   â””â”€â”€ img/                     # Static images
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ assets/                  # Images, icons, fonts
â”‚   â”œâ”€â”€ components/              # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ common/              # Shared components
â”‚   â”‚   â”‚   â”œâ”€â”€ Grid/            # Grid hiá»ƒn thá»‹ 5 Ä‘á»‹a Ä‘iá»ƒm má»›i nháº¥t
â”‚   â”‚   â”‚   â”œâ”€â”€ Preloader/       # Loading animation
â”‚   â”‚   â”‚   â””â”€â”€ TitleSection/    # Title component
â”‚   â”‚   â”œâ”€â”€ Layout/              # Layout components
â”‚   â”‚   â”‚   â”œâ”€â”€ Layout.jsx       # Main layout
â”‚   â”‚   â”‚   â””â”€â”€ UserMenu.jsx     # User menu dropdown
â”‚   â”‚   â”œâ”€â”€ HanoiGo/             # Specific components
â”‚   â”‚   â”œâ”€â”€ Link/                # Custom Link component
â”‚   â”‚   â””â”€â”€ AvatarUpload.jsx     # Avatar upload
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                   # Global custom hooks
â”‚   â”‚   â”œâ”€â”€ useLenis.jsx         # Smooth scrolling
â”‚   â”‚   â”œâ”€â”€ useParallax.js       # Parallax effects
â”‚   â”‚   â”œâ”€â”€ useTextReveal.js     # Text animations
â”‚   â”‚   â””â”€â”€ useHorizontalLoop.js # Horizontal scroll
â”‚   â”‚
â”‚   â”œâ”€â”€ contexts/                # React Context providers
â”‚   â”‚   â”œâ”€â”€ UserContext.jsx      # User state & auth
â”‚   â”‚   â””â”€â”€ CursorContext.jsx    # Custom cursor
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                # API service layer (Axios)
â”‚   â”‚   â””â”€â”€ api.js               # Axios config + API functions
â”‚   â”‚                            #   - authAPI, placesAPI, chatAPI
â”‚   â”‚                            #   - placesAPI.getLatest(5) - Láº¥y 5 Ä‘á»‹a Ä‘iá»ƒm má»›i nháº¥t
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/                   # Top-level page components
â”‚   â”‚   â”œâ”€â”€ Home/                # Trang chá»§
â”‚   â”‚   â”‚   â”œâ”€â”€ Home.jsx         # Main component
â”‚   â”‚   â”‚   â”œâ”€â”€ Hero/            # Hero section
â”‚   â”‚   â”‚   â”œâ”€â”€ Introduction/    # Introduction (chá»©a Grid)
â”‚   â”‚   â”‚   â”œâ”€â”€ OurPartners/     # Partners section
â”‚   â”‚   â”‚   â””â”€â”€ Why/             # Why choose us
â”‚   â”‚   â”œâ”€â”€ SearchResult/        # Search results page
â”‚   â”‚   â”œâ”€â”€ Profile/             # User profile
â”‚   â”‚   â””â”€â”€ Authentication/      # Login/Register
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                   # Helper functions
â”‚   â”‚   â”œâ”€â”€ validators.js        # Form validation
â”‚   â”‚   â”œâ”€â”€ formatters.js        # Data formatting
â”‚   â”‚   â””â”€â”€ constants.js         # App constants
â”‚   â”‚
â”‚   â”œâ”€â”€ App.jsx                  # Root component
â”‚   â”œâ”€â”€ main.jsx                 # Entry point
â”‚   â””â”€â”€ global.css               # Global styles
â”‚
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ rules/                   # Coding rules & conventions
â”‚       â”œâ”€â”€ 00-overview.md
â”‚       â”œâ”€â”€ 01-core-principles.md
â”‚       â”œâ”€â”€ 02-naming-conventions.md
â”‚       â”œâ”€â”€ 03-error-handling.md
â”‚       â”œâ”€â”€ 04-performance-optimization.md
â”‚       â”œâ”€â”€ 05-react-query.md
â”‚       â”œâ”€â”€ 06-code-splitting.md
â”‚       â””â”€â”€ 07-testing-git.md
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.js               # Vite configuration
â””â”€â”€ index.html                   # HTML template
```


***

## ğŸ“‚ Cáº¥u trÃºc ADMIN Dashboard

```
admin/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/                   # CÃ¡c trang admin
â”‚   â”‚   â”œâ”€â”€ Dashboard.tsx        # Thá»‘ng kÃª tá»•ng quan
â”‚   â”‚   â”œâ”€â”€ Places.tsx           # Quáº£n lÃ½ Ä‘á»‹a Ä‘iá»ƒm (legacy)
â”‚   â”‚   â”œâ”€â”€ Users.tsx            # Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
â”‚   â”‚   â”œâ”€â”€ Reviews.tsx          # Quáº£n lÃ½ Ä‘Ã¡nh giÃ¡
â”‚   â”‚   â”œâ”€â”€ AIConfig.tsx         # Cáº¥u hÃ¬nh AI
â”‚   â”‚   â””â”€â”€ index.ts             # Exports
â”‚   â”‚
â”‚   â”œâ”€â”€ features/                # Feature-based modules (NEW)
â”‚   â”‚   â”œâ”€â”€ places/              # Places feature module
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ places.api.ts         # API functions
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ list/                 # List view
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PlacesTable.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PlacesFilters.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PaginationControls.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ shared/               # Shared components
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ StatusBadge.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PlacesListPage.tsx    # Danh sÃ¡ch
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PlaceFormPage.tsx     # Táº¡o/Sá»­a
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PlaceDetailPage.tsx   # Chi tiáº¿t
â”‚   â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ place.types.ts        # TypeScript types
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ formatters.ts         # Format utilities
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ mapPlaceForm.ts       # Form mapping
â”‚   â”‚   â”‚   â”œâ”€â”€ README.md                 # Feature docs
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                  # Exports
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ imports/             # Goong Auto Import module
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ goongImport.api.ts    # Goong API functions
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GoongImportForm.tsx   # Search form
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PredictionsTable.tsx  # Checkbox table
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ImportSummary.tsx     # Result summary
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ImportStatsCard.tsx   # Database stats
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useGoongImport.ts     # React Query hooks
â”‚   â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ GoongImportPage.tsx   # Main import page
â”‚   â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ goongImport.types.ts  # TypeScript types
â”‚   â”‚   â”‚   â”œâ”€â”€ README.md                 # Feature docs
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                  # Exports
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ users/               # Users feature module
â”‚   â”‚       â”œâ”€â”€ api/
â”‚   â”‚       â”‚   â””â”€â”€ users.api.ts
â”‚   â”‚       â”œâ”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ hooks/
â”‚   â”‚       â”œâ”€â”€ pages/
â”‚   â”‚       â”œâ”€â”€ README.md
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ components/              # Shared components
â”‚   â”‚   â”œâ”€â”€ AdminLayout.tsx      # Main layout
â”‚   â”‚   â”œâ”€â”€ ToastProvider.tsx    # Toast notifications
â”‚   â”‚   â””â”€â”€ ui/                  # shadcn/ui components
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                   # Global custom hooks
â”‚   â”œâ”€â”€ services/                # API services
â”‚   â”‚   â””â”€â”€ api.ts               # Axios config
â”‚   â”œâ”€â”€ types/                   # Global TypeScript types
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ utils/                   # Global utilities
â”‚       â””â”€â”€ imageCompression.ts
â”‚
â”œâ”€â”€ tailwind.config.js           # TailwindCSS config
â”œâ”€â”€ tsconfig.json                # TypeScript config
â”œâ”€â”€ vite.config.ts               # Vite config
â”œâ”€â”€ PLACES_MIGRATION.md          # Migration guide
â””â”€â”€ package.json
```

## ğŸ“‚ Cáº¥u trÃºc SERVER Backend

```
server/
â”œâ”€â”€ controllers/                 # Business logic
â”‚   â”œâ”€â”€ authController.js        # Authentication
â”‚   â”œâ”€â”€ placesController.js      # Places management
â”‚   â”‚                            #   - getLatestPlaces() - Láº¥y 5 Ä‘á»‹a Ä‘iá»ƒm má»›i nháº¥t
â”‚   â”œâ”€â”€ userController.js        # User management
â”‚   â”œâ”€â”€ uploadController.js      # File uploads
â”‚   â”œâ”€â”€ reviewController.js      # Review management
â”‚   â””â”€â”€ adminImportController.js # Goong/Google auto import
â”‚
â”œâ”€â”€ models/                      # MongoDB schemas
â”‚   â”œâ”€â”€ User.js                  # User model
â”‚   â”œâ”€â”€ Place.js                 # Place model (vá»›i aiTags, goongId, googlePlaceId)
â”‚   â””â”€â”€ Review.js                # Review model
â”‚
â”œâ”€â”€ routes/                      # API routes
â”‚   â”œâ”€â”€ authRoutes.js            # /api/auth/*
â”‚   â”œâ”€â”€ placeRoutes.js           # /api/places/*
â”‚   â”‚                            #   - GET /latest (5 Ä‘á»‹a Ä‘iá»ƒm má»›i)
â”‚   â”œâ”€â”€ adminRoutes.js           # /api/admin/*
â”‚   â”œâ”€â”€ adminImportRoutes.js     # /api/admin/import/* (Goong/Google)
â”‚   â”œâ”€â”€ chatRoutes.js            # /api/chat/* (RAG chatbot)
â”‚   â”œâ”€â”€ reviewRoutes.js          # /api/reviews/*
â”‚   â”œâ”€â”€ userRoutes.js            # /api/users/*
â”‚   â””â”€â”€ aiRoutes.js              # /api/ai/* (AI operations)
â”‚
â”œâ”€â”€ services/                    # Service layer
â”‚   â”œâ”€â”€ authService.js           # Auth logic
â”‚   â”œâ”€â”€ placeService.js          # Place logic
â”‚   â”œâ”€â”€ userService.js           # User logic
â”‚   â”œâ”€â”€ uploadService.js         # Upload logic
â”‚   â”œâ”€â”€ reviewService.js         # Review logic
â”‚   â”œâ”€â”€ autoTaggerService.js     # Auto-tagging vá»›i AI
â”‚   â”‚
â”‚   â”œâ”€â”€ ai/                      # ğŸ¤– AI Service Module (RAG Architecture)
â”‚   â”‚   â”œâ”€â”€ index.js             # Main exports
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ config/              # Configuration
â”‚   â”‚   â”‚   â”œâ”€â”€ constants.js     # AI constants
â”‚   â”‚   â”‚   â”œâ”€â”€ keywords.js      # Food keywords dictionary
â”‚   â”‚   â”‚   â””â”€â”€ index.js         # Config exports
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ core/                # Core AI components
â”‚   â”‚   â”‚   â”œâ”€â”€ cacheClient.js   # Redis cache
â”‚   â”‚   â”‚   â”œâ”€â”€ llmFactory.js    # LLM provider factory
â”‚   â”‚   â”‚   â”œâ”€â”€ telemetry.js     # Logging & monitoring
â”‚   â”‚   â”‚   â””â”€â”€ vectorStoreFactory.js # Vector DB factory
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ guardrails/          # Input/Output validation
â”‚   â”‚   â”‚   â”œâ”€â”€ inputGuard.js    # Input sanitization
â”‚   â”‚   â”‚   â””â”€â”€ outputGuard.js   # Output validation
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ pipelines/           # AI Processing Pipelines
â”‚   â”‚   â”‚   â”œâ”€â”€ mainChatPipeline.js    # Main RAG chat flow vá»›i intent routing
â”‚   â”‚   â”‚   â”œâ”€â”€ ingestionPipeline.js   # Data ingestion
â”‚   â”‚   â”‚   â”œâ”€â”€ feedbackPipeline.js    # Feedback learning
â”‚   â”‚   â”‚   â””â”€â”€ stages/          # Pipeline stages (modular)
â”‚   â”‚   â”‚       â”œâ”€â”€ 01-InputProcessor.js       # Input processing
â”‚   â”‚   â”‚       â”œâ”€â”€ 02-QueryAnalyzer.js        # Query analysis
â”‚   â”‚   â”‚       â”œâ”€â”€ 03-SemanticRetrieval.js    # Semantic search
â”‚   â”‚   â”‚       â”œâ”€â”€ 04-HybridSearchEngine.js   # Hybrid search
â”‚   â”‚   â”‚       â”œâ”€â”€ 05-RankingEngine.js        # Ranking & reordering
â”‚   â”‚   â”‚       â”œâ”€â”€ 06-PromptBuilder.js        # Prompt construction
â”‚   â”‚   â”‚       â”œâ”€â”€ 07-LLMInvoker.js           # LLM generation
â”‚   â”‚   â”‚       â”œâ”€â”€ 08-ResponseFormatter.js    # Response formatting
â”‚   â”‚   â”‚       â”œâ”€â”€ filters/                   # Query filters
â”‚   â”‚   â”‚       â””â”€â”€ retrieval/                 # Retrieval strategies
â”‚   â”‚   â”‚           â”œâ”€â”€ AddressRegexStrategy.js   # Address matching
â”‚   â”‚   â”‚           â”œâ”€â”€ KeywordSearchStrategy.js  # Keyword search
â”‚   â”‚   â”‚           â””â”€â”€ NearbySearchStrategy.js   # Geospatial search
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ prompts/             # Prompt Engineering
â”‚   â”‚   â”‚   â”œâ”€â”€ promptLoader.js  # Dynamic prompt loader
â”‚   â”‚   â”‚   â””â”€â”€ templates/       # Prompt templates
â”‚   â”‚   â”‚       â”œâ”€â”€ system.v1.txt         # System prompt
â”‚   â”‚   â”‚       â”œâ”€â”€ rag_query.v1.txt      # RAG query
â”‚   â”‚   â”‚       â”œâ”€â”€ query_rewrite.v1.txt  # Query rewriting
â”‚   â”‚   â”‚       â”œâ”€â”€ intent_classify.v1.txt # Intent classification
â”‚   â”‚   â”‚       â””â”€â”€ itinerary_gen.v1.txt  # Itinerary generation
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ retrieval/           # RAG Retrieval Components
â”‚   â”‚   â”‚   â”œâ”€â”€ reranker.js      # Result reranking
â”‚   â”‚   â”‚   â”œâ”€â”€ extractors/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ intentExtractor.js     # Legacy intent extraction
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ intentClassifier.js    # Multi-level intent classification
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ foodKeywordExtractor.js # Food-specific keyword extraction
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ districtExtractor.js   # District/location extraction
â”‚   â”‚   â”‚   â”œâ”€â”€ loaders/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ mongoLoader.js        # MongoDB data loader
â”‚   â”‚   â”‚   â”œâ”€â”€ splitters/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ semanticSplitter.js   # Semantic chunking
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ propositionSplitter.js # Proposition-based
â”‚   â”‚   â”‚   â””â”€â”€ strategies/
â”‚   â”‚   â”‚       â”œâ”€â”€ basicRetriever.js     # Basic retrieval
â”‚   â”‚   â”‚       â”œâ”€â”€ hybridRetriever.js    # Hybrid search
â”‚   â”‚   â”‚       â””â”€â”€ hybridSearch.js       # Search strategy
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ scripts/             # Utility & test scripts
â”‚   â”‚   â”‚   â”œâ”€â”€ runIngestion.js  # Run data ingestion
â”‚   â”‚   â”‚   â”œâ”€â”€ testChat.js      # Test chatbot
â”‚   â”‚   â”‚   â”œâ”€â”€ debugDistrictData.js         # Debug district data
â”‚   â”‚   â”‚   â”œâ”€â”€ testDatingFilter.js          # Test dating recommendations
â”‚   â”‚   â”‚   â”œâ”€â”€ testDatingQuery.js           # Test dating queries
â”‚   â”‚   â”‚   â”œâ”€â”€ testDistrictFilter.js        # Test district filtering
â”‚   â”‚   â”‚   â”œâ”€â”€ testDistrictFilterIntegration.js # Integration tests
â”‚   â”‚   â”‚   â””â”€â”€ verifyDistrictFilter.js      # Verify district logic
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tools/               # AI Tools (Function Calling)
â”‚   â”‚   â”‚   â”œâ”€â”€ index.js         # Tool registry
â”‚   â”‚   â”‚   â”œâ”€â”€ bookingTool.js   # Booking integration
â”‚   â”‚   â”‚   â””â”€â”€ weatherTool.js   # Weather API
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ utils/               # AI Utilities
â”‚   â”‚       â”œâ”€â”€ documentProcessor.js  # Document processing
â”‚   â”‚       â”œâ”€â”€ errorHandler.js       # Error handling
â”‚   â”‚       â”œâ”€â”€ errHandler.js         # Error handler (alternative)
â”‚   â”‚       â”œâ”€â”€ logger.js             # Logging
â”‚   â”‚       â”œâ”€â”€ outputParsers.js      # Output parsing
â”‚   â”‚       â”œâ”€â”€ reorderUtils.js       # Result reordering
â”‚   â”‚       â”œâ”€â”€ tokenCounter.js       # Token counting
â”‚   â”‚       â”œâ”€â”€ distanceUtils.js      # Distance & location utilities
â”‚   â”‚       â””â”€â”€ preferencesMapper.js  # User preferences mapping
â”‚   â”‚
â”‚   â”œâ”€â”€ imports/                 # Import services
â”‚   â”‚   â””â”€â”€ placeImportService.js # Goong/Google import logic
â”‚   â”‚
â”‚   â””â”€â”€ providers/               # External API providers
â”‚       â”œâ”€â”€ goongProvider.js     # Goong Maps API client
â”‚       â””â”€â”€ googleProvider.js    # Google Places API client (náº¿u cÃ³)
â”‚
â”œâ”€â”€ middleware/                  # Express middleware
â”‚   â”œâ”€â”€ auth.js                  # JWT authentication
â”‚   â”œâ”€â”€ errorHandler.js          # Error handling
â”‚   â””â”€â”€ notFound.js              # 404 handler
â”‚
â”œâ”€â”€ utils/                       # Utilities
â”‚   â”œâ”€â”€ placeMapper.js           # Map Goong data â†’ Place schema
â”‚   â””â”€â”€ googlePlaceMapper.js     # Map Google data â†’ Place schema
â”‚
â”œâ”€â”€ scripts/                     # Database & utility scripts
â”‚   â”œâ”€â”€ importGooglePlaces.js    # Import tá»« Google Places
â”‚   â”œâ”€â”€ updateGoogleReviews.js   # Sync Google reviews
â”‚   â”œâ”€â”€ check-data.js            # Data validation
â”‚   â”œâ”€â”€ make-admin.js            # Create admin user
â”‚   â””â”€â”€ ingest-data.js           # Ingest data vÃ o vector DB
â”‚
â”œâ”€â”€ uploads/                     # Local storage (dev)
â”‚   â”œâ”€â”€ avatars/
â”‚   â””â”€â”€ places/
â”‚
â”œâ”€â”€ server.js                    # Main entry point
â”œâ”€â”€ server-simple.js             # Simple server (testing)
â”œâ”€â”€ MIGRATION_GUIDE.md           # Documentation
â”œâ”€â”€ GOONG_MODULE_README.md       # Goong import guide
â”œâ”€â”€ GOONG_IMPORT_GUIDE.md        # API detailed guide
â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md    # Implementation summary
â”œâ”€â”€ QUICK_TEST.md                # Quick test guide
â”œâ”€â”€ PRE_DEPLOYMENT_CHECKLIST.md  # Deploy checklist
â”œâ”€â”€ Goong_Import.postman_collection.json # Postman tests
â”œâ”€â”€ update-users.js              # Utility scripts
â””â”€â”€ package.json
```

## ğŸ“‚ Cáº¥u trÃºc AI Service (Legacy - Deprecated)

**LÆ°u Ã½**: AI service Ä‘Ã£ Ä‘Æ°á»£c tÃ­ch há»£p trá»±c tiáº¿p vÃ o `server/services/ai/`. Folder nÃ y khÃ´ng cÃ²n Ä‘Æ°á»£c sá»­ dá»¥ng.

```
ai-service/ (DEPRECATED)
â”œâ”€â”€ main.py                      # FastAPI application (khÃ´ng dÃ¹ng)
â”œâ”€â”€ requirements.txt             # Python dependencies
â””â”€â”€ .env                         # Environment variables
```

**Migration**: ToÃ n bá»™ AI logic Ä‘Ã£ chuyá»ƒn sang Node.js trong `server/services/ai/` vá»›i kiáº¿n trÃºc RAG hoÃ n chá»‰nh.

## ğŸ“‚ Root Structure

```
HaNoiGo/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ copilot-instructions.md  # TÃ i liá»‡u nÃ y (hÆ°á»›ng dáº«n cho Copilot)
â”‚
â”œâ”€â”€ client/                      # ğŸ¨ Frontend ngÆ°á»i dÃ¹ng (React + Vite)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/          # UI components
â”‚   â”‚   â”œâ”€â”€ pages/               # Route pages
â”‚   â”‚   â”œâ”€â”€ hooks/               # Custom hooks
â”‚   â”‚   â”œâ”€â”€ contexts/            # React contexts
â”‚   â”‚   â””â”€â”€ services/            # API services
â”‚   â””â”€â”€ docs/rules/              # Frontend coding rules
â”‚
â”œâ”€â”€ admin/                       # ğŸ› ï¸ Admin Dashboard (React + TypeScript + Vite)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ features/            # Feature modules
â”‚       â”‚   â”œâ”€â”€ places/          # Places management
â”‚       â”‚   â”œâ”€â”€ imports/         # Goong/Google import
â”‚       â”‚   â””â”€â”€ users/           # User management
â”‚       â”œâ”€â”€ components/          # Shared components
â”‚       â””â”€â”€ pages/               # Admin pages
â”‚
â”œâ”€â”€ server/                      # âš™ï¸ Backend API (Node.js + Express)
â”‚   â”œâ”€â”€ controllers/             # Request handlers
â”‚   â”œâ”€â”€ models/                  # MongoDB schemas
â”‚   â”œâ”€â”€ routes/                  # API routes
â”‚   â”œâ”€â”€ services/                # Business logic
â”‚   â”‚   â”œâ”€â”€ ai/                  # ğŸ¤– RAG AI Service (Node.js)
â”‚   â”‚   â”œâ”€â”€ imports/             # Import services
â”‚   â”‚   â””â”€â”€ providers/           # External API clients
â”‚   â”œâ”€â”€ middleware/              # Express middleware
â”‚   â”œâ”€â”€ scripts/                 # Utility scripts
â”‚   â””â”€â”€ utils/                   # Helper functions
â”‚
â”œâ”€â”€ ai-service/ (DEPRECATED)     # âŒ Old Python AI service (khÃ´ng dÃ¹ng)
â”‚
â”œâ”€â”€ docs/                        # ğŸ“š Project documentation
â”‚
â”œâ”€â”€ dataset_crawler-google-places_*.json # Google Places dataset
â”œâ”€â”€ package.json                 # Workspace config (monorepo)
â”œâ”€â”€ PROJECT_OVERVIEW.md          # Project overview
â”œâ”€â”€ AI.md                        # AI architecture documentation
â”œâ”€â”€ FEATURE_GOOGLE_MAPS_DIRECTIONS.md # Google Maps integration
â””â”€â”€ README.md                    # Getting started guide
```

**ğŸ¯ Tech Stack Summary:**
- **Frontend**: React 18 + Vite + React Query + Axios
- **Admin**: React + TypeScript + Vite + TailwindCSS + shadcn/ui
- **Backend**: Node.js + Express + MongoDB + Redis
- **AI Engine**: OpenAI API + RAG Architecture (LangChain.js)
- **Maps**: Goong Maps API, Google Places API
- **Storage**: Cloudinary (images), MongoDB (data), Redis (cache)

***

## ğŸ—ï¸ KIáº¾N TRÃšC BACKEND CHI TIáº¾T

### ğŸ¯ Kiáº¿n trÃºc tá»•ng quan

Backend HANOIGO tuÃ¢n theo kiáº¿n trÃºc **MVC (Model-View-Controller)** vá»›i **Service Layer** tÃ¡ch biá»‡t, Ä‘áº£m báº£o:

- **Separation of Concerns**: Má»—i layer cÃ³ trÃ¡ch nhiá»‡m riÃªng biá»‡t
- **Testability**: Dá»… dÃ ng unit test tá»«ng layer
- **Scalability**: Dá»… má»Ÿ rá»™ng vÃ  maintain
- **Reusability**: Business logic cÃ³ thá»ƒ tÃ¡i sá»­ dá»¥ng

### ğŸ“Š Luá»“ng xá»­ lÃ½ Request

```
Request â†’ Route â†’ Middleware â†’ Controller â†’ Service â†’ Model â†’ Database
                                    â†“           â†“
                                Response â† Data Processing
```

### âš™ï¸ PhÃ¢n chia trÃ¡ch nhiá»‡m theo Layer

#### 1ï¸âƒ£ **Controller Layer** (controllers/)

**Chá»©c nÄƒng:**
- Nháº­n HTTP request, extract params/body/query
- Validate input cÆ¡ báº£n (gá»i middleware hoáº·c validator)
- Gá»i Service layer Ä‘á»ƒ xá»­ lÃ½ business logic
- Format response vÃ  tráº£ vá» cho client
- **KHÃ”NG chá»©a business logic phá»©c táº¡p**

**âœ… Controller KHÃ”NG lÃ m gÃ¬:**
- KhÃ´ng query database trá»±c tiáº¿p
- KhÃ´ng xá»­ lÃ½ logic phá»©c táº¡p (filter, calculate, transform data)
- KhÃ´ng gá»i external APIs
- KhÃ´ng validate business rules

---

#### 2ï¸âƒ£ **Service Layer** (services/) â­ CORE BUSINESS LOGIC

**Chá»©c nÄƒng:**
- Chá»©a toÃ n bá»™ business logic cá»§a á»©ng dá»¥ng
- Xá»­ lÃ½ data transformation, filtering, sorting
- Validate business rules (vÃ­ dá»¥: user khÃ´ng thá»ƒ review cÃ¹ng 1 place 2 láº§n)
- Gá»i Model Ä‘á»ƒ thao tÃ¡c database
- Gá»i external APIs (OpenAI, Cloudinary, Email service)
- CÃ³ thá»ƒ gá»i Service khÃ¡c (composition)

**âœ… Service lÃ m gÃ¬:**
- Query database thÃ´ng qua Model
- Validate business rules
- Transform data
- Orchestrate complex operations (gá»i nhiá»u Models/Services)
- Handle external API calls

**âŒ Service KHÃ”NG lÃ m gÃ¬:**
- KhÃ´ng xá»­ lÃ½ HTTP request/response
- KhÃ´ng biáº¿t vá» req, res objects
- KhÃ´ng format JSON response

---

#### 3ï¸âƒ£ **Model Layer** (models/)

**Chá»©c nÄƒng:**
- Define MongoDB schema
- Define virtual fields, methods, statics
- Pre/post hooks (middleware)
- Data validation táº¡i DB level
- **Chá»‰ tÆ°Æ¡ng tÃ¡c vá»›i database**

---

### âœ… TÃ“M Táº®T NGUYÃŠN Táº®C

| Layer | TrÃ¡ch nhiá»‡m | VÃ­ dá»¥ code |
|-------|-------------|------------|
| **Route** | Define endpoints, apply middleware | `router.post('/places', protect, createPlace)` |
| **Middleware** | Authentication, validation, error handling | `auth.js`, `validate.js` |
| **Controller** | Handle HTTP, call Service, format response | `const result = await placeService.getPlaces(filters)` |
| **Service** | Business logic, orchestrate operations | `const place = await Place.findById(id)` |
| **Model** | Database schema, validation, indexes | `placeSchema.pre('save', ...)` |

**ğŸ¯ Quy táº¯c vÃ ng:**
- Controller â†’ gá»i Service
- Service â†’ gá»i Model
- Model â†’ tÆ°Æ¡ng tÃ¡c Database
- **KHÃ”NG BAO GIá»œ**: Controller gá»i Model trá»±c tiáº¿p

**âœ¨ Lá»£i Ã­ch:**
- **Testable**: Dá»… viáº¿t unit test cho tá»«ng layer
- **Maintainable**: Thay Ä‘á»•i business logic khÃ´ng áº£nh hÆ°á»Ÿng Controller
- **Reusable**: Service cÃ³ thá»ƒ dÃ¹ng láº¡i á»Ÿ nhiá»u Controller
- **Scalable**: Dá»… má»Ÿ rá»™ng vÃ  refactor

***

## ğŸ¤– KIáº¾N TRÃšC AI SERVICE (RAG ARCHITECTURE)

### ğŸ¯ Tá»•ng quan

AI Service lÃ  "bá»™ nÃ£o" cá»§a HANOIGO, sá»­ dá»¥ng kiáº¿n trÃºc **RAG (Retrieval-Augmented Generation)** káº¿t há»£p:
- **Semantic Search**: TÃ¬m kiáº¿m thÃ´ng minh dá»±a trÃªn ngá»¯ nghÄ©a
- **LLM Generation**: OpenAI GPT-4 Ä‘á»ƒ sinh cÃ¢u tráº£ lá»i tá»± nhiÃªn
- **Intent Classification**: PhÃ¢n loáº¡i Ã½ Ä‘á»‹nh ngÆ°á»i dÃ¹ng Ä‘a cáº¥p
- **Food Keyword Extraction**: TrÃ­ch xuáº¥t tá»« khÃ³a mÃ³n Äƒn chuyÃªn biá»‡t

### ğŸ“Š Luá»“ng xá»­ lÃ½ Chat Query

```
User Input (Tiáº¿ng Viá»‡t)
    â†“
[1] Input Guardrails - Validate & Sanitize
    â†“
[2] Intent Classification (Multi-level)
    â”œâ”€ PRIMARY: find_place | greeting | itinerary | chit_chat
    â”œâ”€ SECONDARY: specific_dish | mood_based | budget_conscious
    â””â”€ FOOD_TYPE: vietnamese | korean | japanese | western
    â†“
[3] Food Keyword Extraction (Náº¿u cÃ³ food intent)
    â”œâ”€ Exact Match: "phá»Ÿ" â†’ PHá»
    â”œâ”€ Fuzzy Match: "pho" â†’ PHá»
    â””â”€ Compound: "bÃºn cháº£" â†’ BÃšN CHáº¢
    â†“
[4] Hybrid Retrieval (MongoDB + Semantic)
    â”œâ”€ Keyword Search: Name, description, menu items
    â”œâ”€ Semantic Tags: aiTags.mood, aiTags.suitability
    â”œâ”€ Location Filter: District, coordinates (near_me)
    â”œâ”€ Price Range: priceRange.min/max
    â””â”€ User Preferences: Æ¯u tiÃªn based on userProfile
    â†“
[5] Re-ranking & Scoring
    â”œâ”€ Relevance Score: TF-IDF + Semantic similarity
    â”œâ”€ User Preference Boost: +10% if match favorites
    â”œâ”€ Distance Penalty: -5% per km (near_me mode)
    â””â”€ Rating Boost: +avgRating * 2%
    â†“
[6] LLM Generation vá»›i Context
    â”œâ”€ System Prompt: Role + Guidelines
    â”œâ”€ Retrieved Context: Top 5-10 places
    â”œâ”€ User Query: Original + intent metadata
    â””â”€ User Preferences: Food, mood, dietary
    â†“
[7] Output Guardrails - Validate Response
    â”œâ”€ JSON Structure Check
    â”œâ”€ Place ID Validation
    â””â”€ Safety Filter (No harmful content)
    â†“
Response (JSON)
{
  "message": "Dáº¡ em tÃ¬m Ä‘Æ°á»£c 3 quÃ¡n phá»Ÿ gáº§n báº¡n...",
  "places": [...],
  "metadata": { "intent": "find_place", "foodType": "vietnamese" }
}
```

### ğŸ§© Module Chi tiáº¿t

#### 1ï¸âƒ£ **Intent Classification** (`retrieval/extractors/intentClassifier.js`)

**Chá»©c nÄƒng**: PhÃ¢n loáº¡i Ã½ Ä‘á»‹nh ngÆ°á»i dÃ¹ng theo **3 cáº¥p Ä‘á»™**

```javascript
// PRIMARY INTENTS
- find_place      // "TÃ¬m quÃ¡n cafe yÃªn tÄ©nh"
- greeting        // "Xin chÃ o", "Hello"
- itinerary       // "Láº­p lá»‹ch trÃ¬nh 3 ngÃ y HÃ  Ná»™i"
- chit_chat       // "HÃ´m nay trá»i Ä‘áº¹p nhá»‰"

// SECONDARY INTENTS (Context)
- specific_dish   // "TÃ¬m quÃ¡n phá»Ÿ"
- mood_based      // "Muá»‘n Ä‘i chá»— lÃ£ng máº¡n"
- budget_conscious // "DÆ°á»›i 100k"
- group_dining    // "Äi nhÃ³m 10 ngÆ°á»i"
- near_me         // "Gáº§n Ä‘Ã¢y", "Quanh Ä‘Ã¢y"

// FOOD TYPE (Category)
- vietnamese      // "Phá»Ÿ", "BÃºn cháº£"
- korean          // "Kimchi", "Bulgogi"
- japanese        // "Sushi", "Ramen"
- western         // "Pizza", "Burger"
- cafe            // "CÃ  phÃª", "Coffee"
```

**VÃ­ dá»¥ Output**:
```json
{
  "primary": "find_place",
  "secondary": ["specific_dish", "budget_conscious"],
  "foodType": "vietnamese",
  "confidence": 0.92
}
```

#### 2ï¸âƒ£ **Food Keyword Extractor** (`retrieval/extractors/foodKeywordExtractor.js`)

**Chá»©c nÄƒng**: TrÃ­ch xuáº¥t tá»« khÃ³a mÃ³n Äƒn tá»« query vá»›i **3 chiáº¿n lÆ°á»£c**

```javascript
// EXACT MATCH - Khá»›p chÃ­nh xÃ¡c
"TÃ¬m quÃ¡n phá»Ÿ" â†’ ["PHá»"]

// FUZZY MATCH - Xá»­ lÃ½ lá»—i chÃ­nh táº£
"pho bo" â†’ ["PHá» BÃ’"]
"bun ca" â†’ ["BÃšN CÃ"]

// COMPOUND DETECTION - MÃ³n Äƒn ghÃ©p
"bÃºn cháº£" â†’ ["BÃšN CHáº¢"] (KHÃ”NG tÃ¡ch thÃ nh "bÃºn" + "cháº£")
"phá»Ÿ cuá»‘n" â†’ ["PHá» CUá»N"]
```

**Food Dictionary**: `config/food-keywords.json`
```json
{
  "vietnamese": ["phá»Ÿ", "bÃºn", "bÃ¡nh mÃ¬", "cháº£ cÃ¡", ...],
  "korean": ["kimchi", "bulgogi", "bibimbap", ...],
  "japanese": ["sushi", "ramen", "tempura", ...],
  "western": ["pizza", "burger", "pasta", ...]
}
```

#### 3ï¸âƒ£ **Hybrid Search** (`retrieval/strategies/hybridSearch.js`)

**Chá»©c nÄƒng**: Káº¿t há»£p **4 loáº¡i search** Ä‘á»ƒ tá»‘i Ä‘a hÃ³a recall

```javascript
// 1. KEYWORD SEARCH (MongoDB Text Index)
{
  $text: { 
    $search: "phá»Ÿ bÃ²", 
    $caseSensitive: false,
    $language: "vietnamese" 
  }
}

// 2. SEMANTIC TAGS MATCH (aiTags)
{
  "aiTags.mood": { $in: ["yÃªn tÄ©nh", "áº¥m cÃºng"] },
  "aiTags.suitability": { $in: ["há»c bÃ i", "lÃ m viá»‡c"] }
}

// 3. CATEGORY + FOOD FILTER
{
  "category": { $in: ["QuÃ¡n Äƒn", "NhÃ  hÃ ng"] },
  "menu.items": { $regex: /phá»Ÿ|bÃºn/i }
}

// 4. GEOSPATIAL SEARCH (Near me)
{
  location: {
    $nearSphere: {
      $geometry: { type: "Point", coordinates: [lng, lat] },
      $maxDistance: 5000 // 5km
    }
  }
}
```

#### 4ï¸âƒ£ **Preferences Mapper** (`utils/preferencesMapper.js`)

**Chá»©c nÄƒng**: Map user preferences sang query filters

```javascript
// User Profile
{
  preferences: {
    favoriteFoods: ["Phá»Ÿ", "BÃºn cháº£"],
    favoriteSpaces: ["YÃªn tÄ©nh", "CÃ³ sÃ¢n vÆ°á»n"],
    dietaryRestrictions: ["Chay", "KhÃ´ng gluten"]
  }
}

// Mapped to Query
{
  boostKeywords: ["phá»Ÿ", "bÃºn cháº£"],
  requiredTags: { "aiTags.space": { $in: ["yÃªn tÄ©nh"] } },
  excludeFilters: { "menu.dietary": { $nin: ["gluten"] } }
}
```

#### 5ï¸âƒ£ **Distance Utils** (`utils/distanceUtils.js`)

**Chá»©c nÄƒng**: TÃ­nh toÃ¡n khoáº£ng cÃ¡ch vÃ  location-based ranking

```javascript
// Haversine Formula - Calculate distance between 2 points
calculateDistance(lat1, lon1, lat2, lon2) â†’ distanceInKm

// Sort by distance
sortByProximity(places, userLocation) â†’ sortedPlaces

// Distance penalty score
applyDistancePenalty(baseScore, distance) {
  // Giáº£m 5% Ä‘iá»ƒm cho má»—i km xa
  return baseScore * (1 - 0.05 * distance);
}
```

### ğŸ”„ Prompt Templates

#### ğŸ“ **intent_classify.v1.txt**
PhÃ¢n loáº¡i Ã½ Ä‘á»‹nh ngÆ°á»i dÃ¹ng vá»›i LLM fallback (khi rule-based fail)

```
Báº¡n lÃ  chuyÃªn gia phÃ¢n tÃ­ch Ã½ Ä‘á»‹nh ngÆ°á»i dÃ¹ng.
PhÃ¢n loáº¡i cÃ¢u há»i sau theo 3 cáº¥p Ä‘á»™:
- PRIMARY: find_place, greeting, itinerary, chit_chat
- SECONDARY: specific_dish, mood_based, budget_conscious...
- FOOD_TYPE: vietnamese, korean, japanese, western

Query: "{userQuery}"

Tráº£ vá» JSON:
{
  "primary": "...",
  "secondary": [...],
  "foodType": "...",
  "confidence": 0.0-1.0
}
```

#### ğŸ—ºï¸ **itinerary_gen.v1.txt**
Sinh lá»‹ch trÃ¬nh du lá»‹ch Ä‘a ngÃ y

```
Báº¡n lÃ  chuyÃªn gia láº­p lá»‹ch trÃ¬nh du lá»‹ch HÃ  Ná»™i.
User yÃªu cáº§u: "{userQuery}"
NgÃ¢n sÃ¡ch: {budget}
Thá»i gian: {days} ngÃ y

Danh sÃ¡ch Ä‘á»‹a Ä‘iá»ƒm kháº£ dá»¥ng:
{retrievedPlaces}

Táº¡o lá»‹ch trÃ¬nh chi tiáº¿t theo format:
{
  "days": [
    {
      "day": 1,
      "title": "KhÃ¡m phÃ¡ phá»‘ cá»•",
      "activities": [
        {
          "time": "08:00",
          "placeId": "...",
          "duration": "2h",
          "note": "..."
        }
      ]
    }
  ]
}
```

### ğŸ“Š Caching Strategy

```javascript
// Redis Cache Layers
L1 - Query Cache (5 mins)
   Key: `chat:query:${hash(userQuery + userId)}`
   Value: { message, places, metadata }

L2 - Intent Cache (30 mins)
   Key: `intent:${hash(userQuery)}`
   Value: { primary, secondary, foodType }

L3 - Search Results Cache (10 mins)
   Key: `search:${hash(filters)}`
   Value: { places: [...], total, timestamp }
```

### ğŸ›¡ï¸ Guardrails

#### Input Guardrails (`guardrails/inputGuard.js`)
- **Max length**: 500 characters
- **Blacklist**: Tá»« cáº¥m, spam keywords
- **Injection Prevention**: SQL, NoSQL, XSS patterns

#### Output Guardrails (`guardrails/outputGuard.js`)
- **JSON Validation**: Parse & validate structure
- **Place ID Check**: Tá»“n táº¡i trong DB
- **Content Safety**: No harmful/offensive content

### ğŸ” Error Handling

```javascript
// AI Service Error Types
AI_INTENT_CLASSIFICATION_FAILED  // KhÃ´ng phÃ¢n loáº¡i Ä‘Æ°á»£c
AI_NO_RESULTS_FOUND              // KhÃ´ng tÃ¬m tháº¥y Ä‘á»‹a Ä‘iá»ƒm
AI_LLM_TIMEOUT                   // OpenAI timeout
AI_INVALID_RESPONSE              // Response khÃ´ng há»£p lá»‡

// Fallback Strategies
1. Intent Classification Failed â†’ Use default "find_place"
2. LLM Timeout â†’ Return cached results + generic message
3. No Results â†’ Suggest alternative queries
```

### ğŸ“ˆ Performance Metrics

| Operation | Target | Actual |
|-----------|--------|--------|
| Intent Classification | < 100ms | ~80ms |
| Food Keyword Extraction | < 50ms | ~30ms |
| Hybrid Search | < 300ms | ~250ms |
| LLM Generation | < 2s | ~1.5s |
| **Total E2E** | **< 3s** | **~2s** |

### ğŸ§ª Testing

```bash
# Test Intent Classifier
node server/services/ai/scripts/testIntentClassifier.js

# Test Food Extractor
node server/services/ai/scripts/testFoodExtractor.js

# Test Full Chat Pipeline
node server/services/ai/scripts/testChat.js \
  --query "TÃ¬m quÃ¡n phá»Ÿ gáº§n Ä‘Ã¢y dÆ°á»›i 100k"
```

***

Axios instance cáº¥u hÃ¬nh sáºµn vá»›i interceptors Ä‘á»ƒ tá»± Ä‘á»™ng:

- Gáº¯n JWT token vÃ o má»i request
- Xá»­ lÃ½ refresh token
- Global error handling


### **hooks/** - React Query Custom Hooks

Quáº£n lÃ½ server state vá»›i caching, optimistic updates, auto-refetch.

### **contexts/** - Authentication Context

Quáº£n lÃ½ user session, login state, vÃ  user preferences.

***

## ğŸ¨ Component Organization

### **PhÃ¢n loáº¡i Components**

- **common/**: Reusable UI primitives (Button, Input, Select)
- **layout/**: Layout wrappers (Navbar, Footer, Sidebar)

***

## ğŸ“Š Data Flow

**User Action** â†’ **Feature Hook** (React Query) â†’ **Service Function** (Axios) â†’ **Backend API** â†’ **Response** â†’ **Cache \& Update UI**

***

## âš¡ Performance

- **Code Splitting**: Lazy load pages vá»›i `React.lazy()`
- **React Query**: Smart caching vÃ  prefetching

***


## ğŸ’¡ Best Practices

âœ… Feature-based organization cho scalability
âœ… Separation of concerns: UI â†” Logic â†” Data
âœ… Reusable custom hooks vá»›i React Query
âœ… Context API chá»‰ cho global state (auth, theme)
âœ… Axios interceptors cho token management
# ğŸ¯ HÆ°á»›ng dáº«n \& NguyÃªn táº¯c PhÃ¡t triá»ƒn CLIENT - HANOIGO

TÃ i liá»‡u nÃ y Ä‘á»‹nh nghÄ©a cÃ¡c tiÃªu chuáº©n, nguyÃªn táº¯c vÃ  hÆ°á»›ng dáº«n tá»‘i Æ°u hÃ³a Ä‘á»ƒ Ä‘áº£m báº£o Frontend **HANOIGO** Ä‘áº¡t hiá»‡u suáº¥t cao, code cháº¥t lÆ°á»£ng vÃ  tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng xuáº¥t sáº¯c.

***

## 1. Táº§m nhÃ¬n \& Quy mÃ´ (Scope)

**HANOIGO Client** lÃ  giao diá»‡n ngÆ°á»i dÃ¹ng cho ná»n táº£ng khÃ¡m phÃ¡ Ä‘á»‹a Ä‘iá»ƒm táº¡i HÃ  Ná»™i, tÃ­ch há»£p AI Chatbot (RAG) vÃ  tÃ¬m kiáº¿m semantic.

- **Tech Stack**: React 18 + Vite + React Query + Axios
- **Architecture**: Feature-based modular structure
- **Target**: Sub-3s load time

***

## 2. NguyÃªn táº¯c Cá»‘t lÃµi (Core Principles)

### ğŸš€ Performance First (Tá»‘i Æ°u Hiá»‡u nÄƒng)

- **Lazy Loading**: LuÃ´n Ã¡p dá»¥ng `React.lazy` vÃ  `Suspense` cho Route components vÃ  heavy components (ChatWindow, MapView, ImageGallery)
- **Image Optimization**:
    - Format **WebP** cho táº¥t cáº£ áº£nh tÄ©nh
    - Cloudinary images luÃ´n dÃ¹ng `f_auto,q_auto,w_800` (responsive width)
    - Lazy load images vá»›i Intersection Observer
- **Minimize Re-renders**:
    - Sá»­ dá»¥ng `useMemo` cho tÃ­nh toÃ¡n phá»©c táº¡p (filter arrays > 50 items)
    - `useCallback` cho functions pass xuá»‘ng child components
    - `React.memo` cho list items (PlaceCard, ReviewCard)
    - TrÃ¡nh inline objects/arrays trong props[^1][^2][^3]
- **Bundle Size**:
    - Initial bundle < 200KB (gzipped)
    - Tree-shake unused code
    - Dynamic imports cho features Ã­t dÃ¹ng


### ğŸ¨ Visual \& UX Excellence

- **Loading States**:
    - **KHÃ”NG BAO GIá»œ** Ä‘á»ƒ mÃ n hÃ¬nh tráº¯ng
    - Skeleton loading cho data fetching (places list, chat history)
    - Spinner component cho mutations (submit review, send message)
- **Feedback**:
    - Toast notification cho má»i user action:
        - âœ… "ÄÃ£ thÃªm vÃ o yÃªu thÃ­ch"
        - âŒ "KhÃ´ng thá»ƒ gá»­i tin nháº¯n, vui lÃ²ng thá»­ láº¡i"
    - Visual feedback cho interactions (button press, card hover)
- **Micro-interactions**:
    - Smooth transitions (0.3s ease-in-out)
    - Hover effects trÃªn PlaceCard (scale: 1.02, shadow lift)
    - Loading animations cho chatbot typing indicator[^4][^5]
- **Accessibility**:
    - ARIA labels cho interactive elements
    - Keyboard navigation (Tab, Enter, Esc)
    - Focus indicators rÃµ rÃ ng


### ğŸ›  Clean Code \& Maintainability

- **DRY (Don't Repeat Yourself)**:
    - TÃ¡ch logic láº·p láº¡i thÃ nh Custom Hooks (`usePlaces`, `useChat`)
    - Shared UI components trong `components/common/`
- **Modular Architecture**:
    - Feature-based structure: má»—i feature tá»± quáº£n lÃ½ components, hooks, pages
    - Single Responsibility: 1 component chá»‰ lÃ m 1 viá»‡c
- **Consistency**: TuÃ¢n thá»§ naming conventions[^6][^7]

***

## 3. Quy chuáº©n Äáº·t tÃªn (Naming Conventions)

### âš›ï¸ React Components \& Files

| Element | Convention | Example |
| :-- | :-- | :-- |
| **Components** | PascalCase | `PlaceCard`, `ChatWindow`, `SearchBar` |
| **Component files** | PascalCase + `.jsx` | `PlaceCard.jsx`, `ReviewForm.jsx` |
| **Pages** | PascalCase + `Page` | `HomePage.jsx`, `PlaceDetailPage.jsx` |
| **Layouts** | PascalCase + `Layout` | `MainLayout.jsx`, `AdminLayout.jsx` |

### ğŸª Hooks \& Services

| Element | Convention | Example |
| :-- | :-- | :-- |
| **Custom Hooks** | `use` + PascalCase | `usePlaces.js`, `useChat.js`, `useAuth.js` |
| **Services** | camelCase + `Service` | `placeService.js`, `chatService.js` |
| **API client** | camelCase | `api.js`, `axiosClient.js` |

### ğŸ“¦ Utils \& Constants

| Element | Convention | Example |
| :-- | :-- | :-- |
| **Utilities** | camelCase | `formatPrice.js`, `debounce.js`, `validateEmail.js` |
| **Constants** | SCREAMING_SNAKE_CASE | `API_BASE_URL`, `MAX_PRICE_RANGE`, `DISTRICTS` |
| **Context** | PascalCase + `Context` | `AuthContext.js`, `ThemeContext.js` |

### ğŸ¨ Styling

| Element | Convention | Example |
| :-- | :-- | :-- |
| **CSS Modules** | PascalCase + `.module.css` | `PlaceCard.module.css` |
| **Tailwind classes** | Alphabetical order | `className="flex items-center gap-4 rounded-lg bg-white p-4"` |

### ğŸ”¤ Variables \& Functions

| Element | Convention | Example |
| :-- | :-- | :-- |
| **State variables** | camelCase | `selectedPlace`, `chatHistory`, `isModalOpen` |
| **Boolean variables** | `is`, `has`, `should` prefix | `isLoading`, `hasError`, `shouldRefetch` |
| **Props** | camelCase | `placeData`, `onSubmit`, `isDisabled` |
| **Event handlers** | `handle` + Action | `handleSubmit`, `handlePlaceSelect`, `handleChatSend` |
| **Functions** | Verb + Noun | `fetchPlaces`, `formatCurrency`, `validateInput` |

**Examples:**

```javascript
// âœ… GOOD
const [selectedPlace, setSelectedPlace] = useState(null);
const [isLoading, setIsLoading] = useState(false);
const handlePlaceClick = useCallback((placeId) => { ... }, []);

// âŒ BAD
const [place, setPlace] = useState(null); // KhÃ´ng rÃµ nghÄ©a
const [loading, setLoading] = useState(false); // Thiáº¿u 'is'
const clickPlace = (placeId) => { ... }; // Thiáº¿u 'handle'
```


***

## 4. Xá»­ lÃ½ Lá»—i (Error Handling)

### ğŸ›¡ï¸ React Error Boundaries

**Setup toÃ n cá»¥c:**

```javascript
// components/common/ErrorBoundary.jsx
import React from 'react';
import ErrorFallback from './ErrorFallback';

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
    // Optional: Send to monitoring (Sentry)
    // Sentry.captureException(error);
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback error={this.state.error} />;
    }
    return this.props.children;
  }
}
```

**Usage trong App.jsx:**

```javascript
<ErrorBoundary>
  <QueryClientProvider client={queryClient}>
    <AuthProvider>
      <App />
    </AuthProvider>
  </QueryClientProvider>
</ErrorBoundary>
```


### ğŸ”§ Axios Interceptor (Centralized Error Handling)

**Setup trong `services/api.js`:**

```javascript
import axios from 'axios';
import { toast } from 'react-toastify';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
  timeout: 10000,
});

// Request interceptor: Attach JWT token
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// Response interceptor: Handle errors globally
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response) {
      const { status, data } = error.response;
      
      switch (status) {
        case 401:
          // Unauthorized: Clear token & redirect
          toast.error('PhiÃªn Ä‘Äƒng nháº­p háº¿t háº¡n');
          localStorage.removeItem('token');
          window.location.href = '/login';
          break;
          
        case 404:
          toast.error(data.message || 'KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u');
          break;
          
        case 500:
          toast.error('Lá»—i server, vui lÃ²ng thá»­ láº¡i sau');
          break;
          
        default:
          toast.error(data.message || 'ÄÃ£ xáº£y ra lá»—i');
      }
    } else if (error.request) {
      // No response from server
      toast.error('KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n server');
    }
    
    return Promise.reject(error);
  }
);

export default api;
```


### ğŸ“¡ React Query Error Handling

**Global error handler:**

```javascript
// lib/reactQuery.js
import { QueryClient } from '@tanstack/react-query';
import { toast } from 'react-toastify';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      retry: 2, // Retry 2 láº§n khi fail
      staleTime: 5 * 60 * 1000, // 5 phÃºt
      refetchOnWindowFocus: false,
      onError: (error) => {
        const message = error.response?.data?.message || 'Lá»—i táº£i dá»¯ liá»‡u';
        toast.error(message);
      },
    },
    mutations: {
      onError: (error) => {
        const message = error.response?.data?.message || 'Thao tÃ¡c tháº¥t báº¡i';
        toast.error(message);
      },
    },
  },
});
```

**Per-hook error handling:**

```javascript
// hooks/usePlaces.js
export const usePlaces = (filters) => {
  return useQuery({
    queryKey: ['places', 'list', filters],
    queryFn: () => placeService.getPlaces(filters),
    onError: (error) => {
      // Custom error handling cho hook nÃ y
      if (error.response?.status === 404) {
        toast.info('KhÃ´ng tÃ¬m tháº¥y Ä‘á»‹a Ä‘iá»ƒm phÃ¹ há»£p');
      }
    },
  });
};
```

**UI Error States:**

```javascript
const PlacesPage = () => {
  const { data, isLoading, isError, error } = usePlaces(filters);

  if (isLoading) return <PlaceSkeleton />;
  
  if (isError) {
    return (
      <ErrorState 
        message="KhÃ´ng thá»ƒ táº£i danh sÃ¡ch Ä‘á»‹a Ä‘iá»ƒm"
        onRetry={() => refetch()}
      />
    );
  }

  return <PlaceList places={data} />;
};
```


### âœ… Error Handling Best Practices

| Rule | Description |
| :-- | :-- |
| **Centralized Handling** | Xá»­ lÃ½ error chung trong Axios interceptor + React Query config |
| **User-Friendly Messages** | Hiá»ƒn thá»‹ message tiáº¿ng Viá»‡t, khÃ´ng leak technical details |
| **Retry Logic** | Tá»± Ä‘á»™ng retry 2 láº§n cho network errors |
| **Fallback UI** | LuÃ´n cÃ³ UI fallback (ErrorBoundary, ErrorState component) |
| **Logging** | Log errors sang console (dev) vÃ  monitoring service (prod) |
| **Toast Notifications** | DÃ¹ng toast cho má»i error Ä‘á»ƒ user aware |

[^8][^9]

***

## 5. Tá»‘i Æ°u Performance (Optimization)

### ğŸ§  useMemo - Memoize Expensive Calculations

**âœ… KHI NÃ€O DÃ™NG:**

1. **Filter/map/reduce array lá»›n (> 50 items)**
```javascript
const filteredPlaces = useMemo(() => {
  return places.filter(place => {
    const matchDistrict = !filters.district || place.district === filters.district;
    const matchPrice = place.priceRange.max <= filters.maxPrice;
    const matchMood = filters.mood ? place.aiTags.mood.includes(filters.mood) : true;
    return matchDistrict && matchPrice && matchMood;
  });
}, [places, filters.district, filters.maxPrice, filters.mood]);
```

2. **Transform data tá»« API**
```javascript
const placesByDistrict = useMemo(() => {
  return places.reduce((acc, place) => {
    if (!acc[place.district]) acc[place.district] = [];
    acc[place.district].push(place);
    return acc;
  }, {});
}, [places]);
```

3. **TÃ­nh toÃ¡n phá»©c táº¡p (> 5ms)**
```javascript
const averageRating = useMemo(() => {
  if (!reviews.length) return 0;
  const sum = reviews.reduce((acc, r) => acc + r.rating, 0);
  return (sum / reviews.length).toFixed(1);
}, [reviews]);
```

**âŒ KHI KHÃ”NG NÃŠN DÃ™NG:**

```javascript
// âŒ BAD: TÃ­nh toÃ¡n quÃ¡ Ä‘Æ¡n giáº£n
const fullName = useMemo(() => {
  return `${firstName} ${lastName}`; // < 0.1ms, khÃ´ng cáº§n memo
}, [firstName, lastName]);

// âŒ BAD: Táº¡o object nhá»
const style = useMemo(() => ({ color: 'red' }), []); // KhÃ´ng cáº§n memo
```


### ğŸ¯ useCallback - Memoize Functions

**âœ… KHI NÃ€O DÃ™NG:**

1. **Function Ä‘Æ°á»£c pass xuá»‘ng child component (trÃ¡nh re-render)**
```javascript
const PlaceList = ({ places }) => {
  const handlePlaceSelect = useCallback((placeId) => {
    navigate(`/places/${placeId}`);
    trackEvent('place_clicked', { placeId });
  }, [navigate]);

  return places.map(place => (
    <PlaceCard 
      key={place._id}
      place={place}
      onSelect={handlePlaceSelect} // KhÃ´ng táº¡o function má»›i má»—i render
    />
  ));
};
```

2. **Function lÃ  dependency cá»§a useEffect/useMemo**
```javascript
const fetchPlaceDetails = useCallback(async (placeId) => {
  const data = await placeService.getPlaceById(placeId);
  setPlaceData(data);
}, []);

useEffect(() => {
  fetchPlaceDetails(placeId);
}, [placeId, fetchPlaceDetails]); // KhÃ´ng trigger re-fetch vÃ´ Ã­ch
```

3. **Event handlers trong lists**
```javascript
const handleReviewSubmit = useCallback((reviewData) => {
  submitReview.mutate({ placeId, ...reviewData });
}, [placeId, submitReview]);
```

**âŒ KHI KHÃ”NG NÃŠN DÃ™NG:**

```javascript
// âŒ BAD: Function chá»‰ dÃ¹ng local, khÃ´ng pass xuá»‘ng
const handleClick = useCallback(() => {
  console.log('clicked'); // KhÃ´ng cáº§n memo
}, []);

// âŒ BAD: Event handler inline Ä‘Æ¡n giáº£n
<button onClick={useCallback(() => setCount(c => c + 1), [])}>
  // QuÃ¡ phá»©c táº¡p cho viá»‡c Ä‘Æ¡n giáº£n
</button>
```


### ğŸ›¡ï¸ React.memo - Prevent Component Re-renders

**âœ… KHI NÃ€O DÃ™NG:**

1. **List items (PlaceCard, ReviewCard)**
```javascript
const PlaceCard = React.memo(({ place, onSelect }) => {
  return (
    <div className="place-card" onClick={() => onSelect(place._id)}>
      <img src={place.images[^0]} alt={place.name} />
      <h3>{place.name}</h3>
      <p>{formatPrice(place.priceRange.min)}</p>
    </div>
  );
});

PlaceCard.displayName = 'PlaceCard';
```

2. **Pure UI components (Button, Badge, Icon)**
```javascript
const Button = React.memo(({ children, onClick, variant = 'primary' }) => {
  return (
    <button className={`btn btn-${variant}`} onClick={onClick}>
      {children}
    </button>
  );
});
```

3. **Heavy components (Charts, Maps)**
```javascript
const PlaceMap = React.memo(({ places, center }) => {
  return <MapView places={places} center={center} />;
}, (prevProps, nextProps) => {
  // Custom comparison: chá»‰ re-render khi places hoáº·c center thay Ä‘á»•i
  return prevProps.places.length === nextProps.places.length &&
         prevProps.center.lat === nextProps.center.lat;
});
```

**âŒ KHI KHÃ”NG NÃŠN DÃ™NG:**

```javascript
// âŒ BAD: Component props thay Ä‘á»•i liÃªn tá»¥c
const Counter = React.memo(({ count }) => {
  return <div>{count}</div>; // count thay Ä‘á»•i má»—i giÃ¢y, memo vÃ´ Ã­ch
});

// âŒ BAD: Component quÃ¡ Ä‘Æ¡n giáº£n
const Text = React.memo(({ children }) => <p>{children}</p>); // KhÃ´ng cáº§n
```


### ğŸš« Anti-Patterns Pháº£i TrÃ¡nh

```javascript
// âŒ BAD: Inline object trong props â†’ táº¡o má»›i má»—i render
<PlaceCard style={{ margin: 10 }} />

// âœ… GOOD: Hoist ra ngoÃ i
const cardStyle = { margin: 10 };
<PlaceCard style={cardStyle} />

// âŒ BAD: Inline array trong props
<PlaceCard tags={['cafe', 'quiet']} />

// âœ… GOOD: useMemo hoáº·c constant
const tags = useMemo(() => ['cafe', 'quiet'], []);
<PlaceCard tags={tags} />

// âŒ BAD: Anonymous function trong prop
<button onClick={() => handleClick(id)}>Click</button>

// âœ… GOOD: useCallback
const onClick = useCallback(() => handleClick(id), [id]);
<button onClick={onClick}>Click</button>

// âŒ BAD: Nested map/filter trong render
{places.map(p => p.reviews.filter(r => r.rating > 4).map(...))}

// âœ… GOOD: useMemo
const topReviews = useMemo(() => {
  return places.flatMap(p => 
    p.reviews.filter(r => r.rating > 4)
  );
}, [places]);
```


### ğŸ“Š Optimization Decision Tree

```
CÃ³ pháº£i tÃ­nh toÃ¡n phá»©c táº¡p (> 5ms)?
â”œâ”€ YES â†’ useMemo
â””â”€ NO â†’ KhÃ´ng cáº§n optimize

Function Ä‘Æ°á»£c pass xuá»‘ng child?
â”œâ”€ YES â†’ useCallback
â””â”€ NO â†’ KhÃ´ng cáº§n optimize

Component re-render khÃ´ng cáº§n thiáº¿t?
â”œâ”€ YES â†’ React.memo
â””â”€ NO â†’ KhÃ´ng cáº§n optimize
```


### ğŸ” Profiling \& Measurement

**Tools:**

- **React DevTools Profiler**: Record vÃ  phÃ¢n tÃ­ch render time
- **Chrome DevTools Performance**: Flame chart toÃ n bá»™ app
- **Lighthouse**: Check Core Web Vitals

**Metrics má»¥c tiÃªu:**

- First Contentful Paint (FCP) < 1.8s
- Largest Contentful Paint (LCP) < 2.5s
- Total Blocking Time (TBT) < 300ms
- Cumulative Layout Shift (CLS) < 0.1

**Khi nÃ o cáº§n optimize:**

1. Component render > 16ms (60 FPS)
2. User interaction bá»‹ lag
3. Lighthouse score < 90

[^2][^3][^10][^1]

***

## 6. React Query Best Practices

### ğŸ”‘ Query Keys Structure (Hierarchical)

```javascript
// âœ… GOOD: Tá»• chá»©c query keys theo hierarchy
['places'] // Base key
['places', 'list'] // All places
['places', 'list', { district: 'Ba Dinh' }] // Filtered places
['places', 'detail', placeId] // Single place
['places', 'reviews', placeId] // Place's reviews

['chat', 'history', userId] // Chat history
['chat', 'message', messageId] // Single message

['user', 'profile'] // Current user
['user', 'preferences'] // User preferences
```

**Lá»£i Ã­ch:**

- Dá»… invalidate queries: `invalidateQueries(['places'])` â†’ clear táº¥t cáº£ place-related
- Consistent vÃ  predictable


### ğŸ’¾ Caching Strategy

```javascript
// hooks/usePlaces.js
export const usePlaces = (filters = {}) => {
  return useQuery({
    queryKey: ['places', 'list', filters],
    queryFn: () => placeService.getPlaces(filters),
    
    // Caching config
    staleTime: 5 * 60 * 1000, // 5 phÃºt - data cÃ²n "fresh"
    gcTime: 10 * 60 * 1000, // 10 phÃºt - giá»¯ trong cache
    
    // Refetch behavior
    refetchOnWindowFocus: false, // KhÃ´ng refetch khi switch tab
    refetchOnReconnect: true, // Refetch khi reconnect internet
    
    // Retry
    retry: 2, // Retry 2 láº§n khi fail
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
};
```

**Caching rules theo data type:**


| Data Type | staleTime | gcTime | LÃ½ do |
| :-- | :-- | :-- | :-- |
| Static data (categories, districts) | 30 mins | 1 hour | Ãt thay Ä‘á»•i |
| User profile | 10 mins | 30 mins | Thay Ä‘á»•i trung bÃ¬nh |
| Place details | 5 mins | 15 mins | CÃ³ thá»ƒ update |
| Search results | 2 mins | 5 mins | Thay Ä‘á»•i thÆ°á»ng xuyÃªn |
| Chat messages | 0 | 2 mins | Real-time data |

### ğŸ”„ Optimistic Updates (UX Tá»‘t hÆ¡n)

```javascript
// hooks/useReviews.js
export const useSubmitReview = (placeId) => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: (reviewData) => reviewService.submitReview(placeId, reviewData),
    
    // OPTIMISTIC UPDATE
    onMutate: async (newReview) => {
      // 1. Cancel outgoing refetches (trÃ¡nh race condition)
      await queryClient.cancelQueries(['places', 'reviews', placeId]);
      
      // 2. Snapshot current data (Ä‘á»ƒ rollback náº¿u fail)
      const previousReviews = queryClient.getQueryData(['places', 'reviews', placeId]);
      
      // 3. Optimistically update UI (user tháº¥y ngay)
      queryClient.setQueryData(['places', 'reviews', placeId], (old) => {
        return [...(old || []), { ...newReview, _id: 'temp-id', createdAt: new Date() }];
      });
      
      return { previousReviews };
    },
    
    onError: (err, newReview, context) => {
      // 4. Rollback náº¿u API fail
      queryClient.setQueryData(
        ['places', 'reviews', placeId],
        context.previousReviews
      );
      toast.error('KhÃ´ng thá»ƒ gá»­i Ä‘Ã¡nh giÃ¡');
    },
    
    onSuccess: () => {
      toast.success('ÄÃ¡nh giÃ¡ Ä‘Ã£ Ä‘Æ°á»£c gá»­i');
    },
    
    onSettled: () => {
      // 5. Refetch Ä‘á»ƒ sync vá»›i server
      queryClient.invalidateQueries(['places', 'reviews', placeId]);
      queryClient.invalidateQueries(['places', 'detail', placeId]); // Update avg rating
    },
  });
};
```


### ğŸ“¡ Prefetching (TÄƒng Performance)

```javascript
// Prefetch place details khi hover PlaceCard
const PlaceCard = ({ place }) => {
  const queryClient = useQueryClient();
  
  const handleMouseEnter = () => {
    queryClient.prefetchQuery({
      queryKey: ['places', 'detail', place._id],
      queryFn: () => placeService.getPlaceById(place._id),
      staleTime: 60000, // Cache 1 phÃºt
    });
  };
  
  return (
    <div onMouseEnter={handleMouseEnter}>
      <Link to={`/places/${place._id}`}>{place.name}</Link>
    </div>
  );
};
```


### ğŸ” Pagination vá»›i keepPreviousData

```javascript
export const usePlaces = (page, filters) => {
  return useQuery({
    queryKey: ['places', 'list', page, filters],
    queryFn: () => placeService.getPlaces({ page, ...filters }),
    keepPreviousData: true, // Giá»¯ data cÅ© khi chuyá»ƒn trang â†’ khÃ´ng blink
  });
};

// Usage trong component
const PlacesPage = () => {
  const [page, setPage] = useState(1);
  const { data, isLoading, isFetching } = usePlaces(page, filters);
  
  return (
    <>
      <PlaceList places={data?.places} />
      {isFetching && <LoadingOverlay />} // Show loading khi fetch page má»›i
      <Pagination page={page} onPageChange={setPage} />
    </>
  );
};
```


***

## 7. Code Splitting \& Lazy Loading

### ğŸ“¦ Route-based Code Splitting

```javascript
// App.jsx
import { lazy, Suspense } from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import LoadingSpinner from './components/common/LoadingSpinner';

// âœ… Lazy load pages
const HomePage = lazy(() => import('./pages/HomePage'));
const PlacesPage = lazy(() => import('./pages/PlacesPage'));
const PlaceDetailPage = lazy(() => import('./pages/PlaceDetailPage'));
const ChatbotPage = lazy(() => import('./pages/ChatbotPage'));
const AdminDashboard = lazy(() => import('./features/admin/pages/AdminDashboard'));

function App() {
  return (
    <BrowserRouter>
      <Suspense fallback={<LoadingSpinner />}>
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/places" element={<PlacesPage />} />
          <Route path="/places/:id" element={<PlaceDetailPage />} />
          <Route path="/chat" element={<ChatbotPage />} />
          <Route path="/admin" element={<AdminDashboard />} />
        </Routes>
      </Suspense>
    </BrowserRouter>
  );
}
```


### ğŸ¯ Component-based Lazy Loading

```javascript
// Heavy components nhÆ° Map, Chart
const PlaceMap = lazy(() => import('./components/PlaceMap'));

const PlaceDetailPage = () => {
  return (
    <div>
      <PlaceInfo />
      <Suspense fallback={<MapSkeleton />}>
        <PlaceMap places={nearbyPlaces} />
      </Suspense>
    </div>
  );
};
```


***

## 9. Testing Checklist

- âœ… Unit tests cho utility functions (`formatPrice`, `validateEmail`)
- âœ… Hook tests vá»›i `@testing-library/react-hooks`
- âœ… Component tests vá»›i `@testing-library/react`
- âœ… Integration tests cho user flows (Search â†’ Select Place â†’ Submit Review)
- âœ… E2E tests vá»›i Playwright/Cypress cho critical paths

***

## 10. Git Commit Messages

**Format**: `type: description`

**Types:**

- `feat`: TÃ­nh nÄƒng má»›i (`feat: Add place favorite feature`)
- `fix`: Fix bug (`fix: Resolve chat scroll issue`)
- `perf`: Performance optimization (`perf: Optimize place list rendering`)
- `refactor`: Code refactoring (`refactor: Extract PlaceCard logic to hook`)
- `style`: UI/CSS changes (`style: Update place card hover effect`)
- `test`: Add tests (`test: Add PlaceCard component tests`)

***

## âœ… Final Checklist

TrÆ°á»›c khi commit/deploy, Ä‘áº£m báº£o:

- [ ] KhÃ´ng cÃ³ console.log/debugger trong code
- [ ] Táº¥t cáº£ images Ä‘Ã£ optimize (WebP, lazy load)
- [ ] Components náº·ng Ä‘Ã£ Ä‘Æ°á»£c memo/lazy load
- [ ] Error boundaries Ä‘Ã£ wrap routes chÃ­nh
- [ ] Loading states cho táº¥t cáº£ async operations
- [ ] Toast notifications cho user actions
- [ ] Mobile responsive (test tá»« 320px)
- [ ] Accessibility: ARIA labels, keyboard navigation
- [ ] No TypeScript/ESLint errors
- [ ] Lighthouse score > 90

***

**ğŸ¯ Má»¥c tiÃªu cuá»‘i cÃ¹ng**: Code clean, performant, maintainable, vÃ  mang láº¡i tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng xuáº¥t sáº¯c!
